<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Test - Codebase Time Machine</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin: 20px 0; }
        input, button { padding: 10px; margin: 5px; }
        input[type="url"] { width: 400px; }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        .result { margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Form Submission Test</h1>
        <p>This page tests if form submissions work without CSP blocking.</p>
        
        <div class="form-group">
            <h3>Test 1: GitHub Repository Analysis</h3>
            <form id="repo-form">
                <input type="url" id="repo-url" value="https://github.com/octocat/Hello-World.git" placeholder="GitHub Repository URL" required>
                <button type="submit">Analyze Repository</button>
            </form>
            <div id="repo-result" class="result" style="display:none;"></div>
        </div>

        <div class="form-group">
            <h3>Test 2: Simple Query</h3>
            <form id="query-form">
                <input type="text" id="query-text" value="Who are the main contributors?" placeholder="Ask a question" required>
                <button type="submit">Submit Query</button>
            </form>
            <div id="query-result" class="result" style="display:none;"></div>
        </div>

        <div class="form-group">
            <h3>Test 3: File Upload</h3>
            <form id="upload-form" enctype="multipart/form-data">
                <input type="file" id="file-input" accept=".zip" required>
                <button type="submit">Upload & Analyze</button>
            </form>
            <div id="upload-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        console.log('üöÄ Form test page loaded');

        // Test 1: Repository Analysis
        document.getElementById('repo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('ÔøΩÔøΩ Repository form submitted');
            
            const url = document.getElementById('repo-url').value;
            const resultDiv = document.getElementById('repo-result');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '‚è≥ Analyzing repository...';
            
            try {
                const response = await fetch('/api/analyze-repo-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ repoUrl: url })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Analysis Successful!</h4>
                        <p><strong>Repository:</strong> ${data.analysis.repo_url}</p>
                        <p><strong>Total Commits:</strong> ${data.analysis.structure_info.total_commits}</p>
                        <p><strong>Contributors:</strong> ${data.analysis.structure_info.contributors_count}</p>
                        <p><strong>Analysis ID:</strong> ${data.analysis.repo_id}</p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Error: ${data.error || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Network Error: ${error.message}`;
            }
        });

        // Test 2: Query
        document.getElementById('query-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('üîé Query form submitted');
            
            const query = document.getElementById('query-text').value;
            const resultDiv = document.getElementById('query-result');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '‚è≥ Processing query...';
            
            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query, repoId: '1d60d0a17c4d' })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Query Successful!</h4>
                        <p><strong>Answer:</strong> ${data.answer || 'Query processed successfully'}</p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Error: ${data.error || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Network Error: ${error.message}`;
            }
        });

        // Test 3: File Upload
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('üìÅ Upload form submitted');
            
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            const resultDiv = document.getElementById('upload-result');
            
            resultDiv.style.display = 'block';
            
            if (!file) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '‚ùå Please select a ZIP file to upload';
                return;
            }
            
            resultDiv.className = 'result';
            resultDiv.innerHTML = '‚è≥ Uploading and analyzing...';
            
            try {
                const formData = new FormData();
                formData.append('repoFile', file);
                
                const response = await fetch('/api/upload-repo', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Upload Successful!</h4>
                        <p><strong>File:</strong> ${file.name}</p>
                        <p><strong>Analysis:</strong> Repository uploaded and analyzed successfully</p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Error: ${data.error || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Network Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>
